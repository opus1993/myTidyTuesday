---
title: "R Package Vignette Counts"
author: "Jim Gruman"
date: "March 14, 2022"
output:
  workflowr::wflow_html:
    toc: no
    code_folding: hide
    code_download: true
    df_print: paged
editor_options:
  chunk_output_type: console
---

This week's dataset comes from Dr. Robert Flight and covers the evolution of the built in R package help documentation, often called Vignettes.

```{r setup, message=FALSE}

suppressPackageStartupMessages({
library(tidyverse) # clean and transform rectangular data
library(grumanlib) # my plot theme
library(treemapify)
library(tidymodels)
library(poissonreg)
})

tidymodels_prefer()

source(here::here("code","_common.R"),
       verbose = FALSE,
       local = knitr::knit_global())

theme_set(grumanlib::theme_jim())

```

Load up the data to have a look

```{r}
cran <- tidytuesdayR::tt_load("2022-03-15")$cran %>% 
  mutate(MajorVersion = as.integer(str_extract(version, "^[0-9]\\.")),
         VignetteCount = as.integer(rmd + rnw),
         date = lubridate::parse_date_time(date,
                                           orders = c("Ymd HMS","a b d HMS Y")),
         package = str_to_lower(package),
         ReleaseYear = lubridate::year((lubridate::floor_date(date, "year")))) %>% 
  group_by(package, MajorVersion) %>% 
  mutate(ReleaseType = case_when(
           row_number(date) == 1L ~ "Major",
           TRUE ~ "Minor")) %>% 
  ungroup() 

downloads <- cranlogs::cran_top_downloads("last-month", count = 100) %>%
  mutate(package = str_to_lower(package))

```

```{r exploratory}
cran %>% 
  mutate(has_vignette = VignetteCount > 0) %>%  
  count(ReleaseYear, ReleaseType, has_vignette,
        name = "vignettes") %>% 
  filter(ReleaseYear > 2003) %>% 
  ggplot(aes(x = ReleaseYear, vignettes, fill = has_vignette)) +
  geom_col() +
  facet_wrap(~ ReleaseType) +
  labs(caption = "2021 is a partial year, ending August 12th",
       y = "Count of Releases published on CRAN",
       fill = "Has A Vignette") +
  theme(legend.position = "top")

```

```{r final_plot, fig.asp=1}

vignette_counts <- cran %>% 
  arrange(package, date) %>% 
  filter(!is.na(date)) %>% 
  group_by(package) %>% 
  summarise(vignettes = last(VignetteCount),
            born_on = lubridate::year(min(date)),
            age = round(
              lubridate::interval(min(date), Sys.Date()) / lubridate::years(1), 1), 
            releases = n(),
            .groups = "drop") %>% 
    inner_join(downloads, by = "package") 

vignette_counts %>% 
  mutate(package = glue::glue("{ package } \n { vignettes }")) %>% 
  ggplot(aes(
    area = count,
    fill = vignettes,
    label = package,
    subgroup = cut_interval(born_on, n = 4)
  )) +
  geom_treemap(show.legend = FALSE) +
  geom_treemap_subgroup_border() +
  geom_treemap_text(aes(color = after_scale(map_chr(fill, best_contrast))),
    place = "top",
    reflow = TRUE
  ) +
    geom_treemap_subgroup_text(
    color = "white",
    alpha = 0.2,
    place = "bottomleft",
    fontface = "italic",
    min.size = 0
  ) +
  labs(
    fill = NULL, title = "Top Most Downloaded R Packages from CRAN",
    subtitle = "Package Name and Number of Vignettes labeled. Size corresponds to the Total Number of Downloads from 14Feb-15Mar2022.",
    caption = "Data Source: Robert Flight and cranlogs"
  ) +
  theme(legend.position = "none")

```


```{r}
tweetrmd::include_tweet("https://twitter.com/jim_gruman/status/1504143273925148672")
```

Let's build on Julia Silge's video from [this week](https://juliasilge.com/blog/rstats-vignettes/) on Machine Learning with `tidymodels`.

A regression model of counts is often best modeled with the poisson distribution

```{r}

poisson_wf <- workflow(vignettes ~ releases , poisson_reg())

fit(poisson_wf, data = vignette_counts)

```

Let's try a zero inflated model, with the zero inflated terms, that is, those with a probability of being zero, modeled by `born_on` year.

```{r}

zip_spec <- poisson_reg() %>% set_engine("zeroinfl")

zip_wf <- workflow() %>% 
  add_model(zip_spec, formula = vignettes ~ releases | releases   ) %>% 
  add_variables(outcomes = vignettes,
                predictors = c(releases, born_on   ))

fit(zip_wf, data = vignette_counts)

```

Bootstrapping to better understand the model coefficients for inference

```{r}
folds <- bootstraps(vignette_counts, times = 100)
```

Let's speed this up as best as we can with parallel processing.

```{r}
all_cores <- parallelly::availableCores(omit = 1)
all_cores

future::plan("multisession", workers = all_cores) # on Windows
```



```{r}

get_coefficients <- function(x){
  extract_fit_engine(x) %>% 
    tidy(type = "zero")
}

ctrl <- control_resamples(
  extract = get_coefficients
)

zip_res <- fit_resamples(zip_wf, 
                         folds,
                         control = ctrl)

```

For all of the bootstraps, what is the estimate of the coefficient statistic?  Let's make a plot:

```{r}
zip_res %>%
  select(id, .extracts) %>%
  unnest(.extracts) %>%
  unnest(.extracts) %>%
  ggplot(aes(x = estimate, fill = term)) +
  geom_histogram(show.legend = FALSE, bins = 35) +
  facet_wrap( ~ term, scales = "free_x") +
  geom_vline(
    xintercept = 0,
    lty = 2,
    size = 1.2,
    color = "gray70"
  ) +
  labs(caption = "Zero Inflated Poisson model for Vignette Counts on R Packages",
       subtitle = "More releases means more vignettes")
```



