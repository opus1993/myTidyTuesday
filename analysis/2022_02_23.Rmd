---
title: "Plotting NHL Stats"
author: "Jim Gruman"
date: "February 23, 2022"
output:
  workflowr::wflow_html:
    toc: no
    code_folding: hide
    code_download: true
    df_print: paged
editor_options:
  chunk_output_type: console
---

There is definitely a learning curve in both mastering the craft of making great data visualizations and in finding the best way to build code with `ggplot2` to generate them.

[Meghan Hall](https://meghan.rbind.io/about/) of  [Hockey-Graphs](https://hockey-graphs.com/about/) recently tweeted and blogged on [Increasing the Flexibility and Robustness of Plots in `ggplot2`](https://meghan.rbind.io/blog/plot-robustness/) and I'd like to build on her work. Please check out her post and follow here:

```{r}
tweetrmd::include_tweet(tweet_url = "https://twitter.com/MeghanMHall/status/1496155738246467588")
```

I really enjoy pulling wild-caught data and working with newly released R packages to improve my understanding of what is awesome out there. As Megan did in her example, we are going to pull data through the [`hockeyR`](https://hockeyr.netlify.app/) package that scrapes play by play data from `NHL.com`.

```{r setup, message=FALSE}

suppressPackageStartupMessages({
library(tidyverse) # clean and transform rectangular data
library(hockeyR)
library(sportyR)
library(cowplot)
library(grumanlib) # my plot theme
})

source(here::here("code","_common.R"),
       verbose = FALSE,
       local = knitr::knit_global())

ggplot2::theme_set(
  theme_jim(base_size = 12) %+replace%
    theme(
      panel.background  = element_blank(),
      plot.background = element_rect(fill = "transparent", color = NA),
      legend.background = element_rect(fill = "transparent", color = NA),
      legend.key = element_rect(fill = "transparent", color = NA),
      axis.ticks = element_blank(),
      panel.grid.major = element_line(color = "grey90", size = 0.3),
      panel.grid.minor = element_blank()
    )
)

```

Lets load up the current 2021-22 season of play by play NHL data.

```{r load_data}
pbp <- load_pbp(season = as.numeric(format(Sys.Date() + 184, "%Y")))

team_info <- hockeyR::team_logos_colors

```

Let's first look at a single game. In fact, I'd like to see the most recent game. An easy way to create a shot plot is through the `sportyR` package. We will also use the included `team_colors_logos` data to add color and team logos to an example plot that closely follows the `hockeyR` vignette.

```{r}
# get the most recent Chicago Blackhawks game data
game <- pbp %>%
  filter(home_abbreviation == "CHI") %>% 
  filter(game_date == max(game_date) )

# grab team logos & colors
team_logos <- team_info %>%
  filter(team_abbr == unique(game$home_abbreviation) | team_abbr == unique(game$away_abbreviation)) %>%
  # add in dummy variables to put logos on the ice
  mutate(x = ifelse(full_team_name == unique(game$home_name), 50, -50),
         y = 0)

# add transparency to the logo
transparent <- function(img) {
  magick::image_fx(img, expression = "0.3*a", channel = "alpha")
}

# get only shot events
events <- c("MISSED_SHOT","SHOT","GOAL")

shots <- game %>% filter(event_type %in% events) %>%
  # adding team colors
  left_join(team_logos, by = c("event_team_abbr" = "team_abbr"))

# create shot plot
geom_hockey("nhl") +
  ggimage::geom_image(
    data = team_logos,
    aes(x = x, y = y, image = team_logo_espn),
    image_fun = transparent, size = 0.22, asp = 2.35
    ) +
  geom_point(
    data = shots,
    aes(x_fixed, y_fixed),
    size = 6,
    color = shots$team_color1,
    shape = ifelse(shots$event_type == "GOAL", 19, 1)
    ) +
  labs(
    title = glue::glue("{unique(game$away_name)} @ {unique(game$home_name)}"),
    subtitle = glue::glue(
    "{format(unique(game$game_date), '%b %d, %Y')}\n
    {unique(shots$away_abbreviation)} {unique(shots$away_final)} - {unique(shots$home_final)} {unique(shots$home_abbreviation)}"
    ), y = NULL, x = NULL,
    caption = "@jim_gruman | data from hockeyR | plot made with sportyR"
    ) +
  theme(
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    plot.caption = element_text(hjust = .9),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    plot.margin = margin(b = 0),
    panel.grid.major = element_blank()
    )
```

Next, let's create a plotting function that shows the top scorers for any single NHL team for the entire 2021-22 season so far. We are going to need to add the information from the rosters, and clean up positions.

```{r}
roster <- get_rosters(team = "all", 
                      season = as.numeric(format(Sys.Date() + 184, "%Y")))

position <- roster %>% 
  select(player, position) %>% 
  unique() %>% 
  mutate(position = case_when(position == "F" ~ "forward", 
                              TRUE ~ "defenseman"))

```

Let's also calculate the total points scored for each player, much like Meghan did in her blog post.

```{r}
points <- pbp %>% 
  # all goals except for those in the shootout
  dplyr::filter(event_type == "GOAL" & period != 5) %>% 
  # event players 1-3 are those who might get points on each goal
  select(game_id, game_date, team = event_team_abbr, event_player_1_name, 
         event_player_2_name, event_player_3_name, event_player_1_type, 
         event_player_2_type, event_player_3_type) %>% 
  # this will create a name/type combo for players 1 through 3
  pivot_longer(event_player_1_name:event_player_3_type,
               names_to = c(NA, ".value"),
               names_pattern = "(.+)_(.+)") %>% 
  # only the players who either scored the goal or got an assist
  dplyr::filter(type %in% c("Assist", "Scorer")) %>% 
  count(name, team, name = "points") %>% 
  mutate(name = str_replace_all(name, "\\.", " "))
```

Similarly, lets calculate an accumulated Time on Ice (TOI) for each player much as Meghan did, but with `summarize(.groups = "drop")` and `slice_max()`.

```{r}
# calculate TOI for each player

TOI <- pbp %>%
  # create a variable for the length of each event
  mutate(length = case_when(
    lead(game_id) == game_id ~
      lead(period_seconds) - period_seconds,
    TRUE ~ 0
  )) %>%
  select(length,
         game_id,
         home_abbreviation,
         away_abbreviation,
         home_on_1:away_on_7) %>%
  filter(length > 0) %>%
  pivot_longer(home_on_1:away_on_7,
               names_to = "team",
               values_to = "name") %>%
  filter(!is.na(name)) %>%
  mutate(team = ifelse(
    str_detect(team, "home"),
    home_abbreviation,
    away_abbreviation
  )) %>%
  select(-c(3:4)) %>%
  group_by(name, team) %>%
  # calculate total TOI and games played
  summarize(TOI = sum(length) / 60,
            GP = n_distinct(game_id),
            .groups = "drop") %>%
  mutate(name = str_replace_all(name, "\\.", " ")) %>%
  filter(TOI > 200 & !(name %in% c("Marc Andre Fleury",
                                   "Ukko Pekka Luukkonen"))) %>%
  # make some name adjustments to account for discrepancies 
  mutate(
    name = case_when(
      name == "Drew O Connor" ~ "Drew O'Connor",
      name == "Logan O Connor" ~ "Logan O'Connor",
      name == "Liam O Brien" ~ "Liam O'Brien",
      name == "Ryan O Reilly" ~ "Ryan O'Reilly",
      name == "Jean Gabriel Pageau" ~ "Jean-Gabriel Pageau",
      name == "K Andre Miller" ~ "K'Andre Miller",
      name == "Marc Edouard Vlasic" ~ "Marc-Edouard Vlasic",
      name == "Pierre Edouard Bellemare" ~ "Pierre-Edouard Bellemare",
      name == "Nicolas Aube Kubel" ~ "Nicolas Aube-Kubel",
      name == "Oliver Ekman Larsson" ~ "Oliver Ekman-Larsson",
      name == "Pierre Luc Dubois" ~ "Pierre-Luc Dubois",
      name == "Ryan Nugent Hopkins" ~ "Ryan Nugent-Hopkins",
      name == "Zach Aston Reese" ~ "Zach Aston-Reese",
      TRUE ~ name
    )
  ) %>%
  # join in points data to calculate rate
  left_join(points, by = c("name", "team")) %>%
  mutate(points = replace_na(points, 0),
         pts_per_60 = points * 60 / TOI)

top_points <- TOI %>%
  left_join(position, by = c("name" = "player")) %>%
  # filter to only the top 10 players per team
  group_by(team) %>%
  slice_max(n = 10, order_by = pts_per_60) %>% 
  left_join(select(team_info, full_team_name, team = team_abbr),
            by = "team")
```

This plot has an annotation in the lower-right corner that lists the teamâ€™s record and its rank within its division. Let's go back and pull them together as well.

```{r}
# calculate the result of the shootouts by the team that has more goals
SO <- pbp %>%
  group_by(game_id) %>%
  filter(max(period) == 5) %>%
  filter(event_type == "GOAL") %>%
  count(game_id, event_team_type) %>%
  pivot_wider(names_from = event_team_type, values_from = n) %>%
  mutate(SO_result = ifelse(home > away, "home", "away"))

records <- pbp %>%
  # calculate the home and away score and game type, by how many game periods
  # 3 periods: regulation; 4: overtime; 5: shootout
  group_by(
    game_id,
    home_abbreviation,
    away_abbreviation,
    home_division_name,
    away_division_name
  ) %>%
  summarize(
    home = max(home_final),
    away = max(away_final),
    period = max(period),
    .groups = "drop"
  ) %>%
  left_join(select(SO,-c(2:3)), by = "game_id") %>%
  # get standings points per game: 2 for win, 1 for OT/SO loss, 0 for reg loss
  mutate(
    home = ifelse(is.na(SO_result) |
                    SO_result == "away", home, home + 1),
    away = ifelse(is.na(SO_result) |
                    SO_result == "home", away, away + 1),
    home_points = case_when(home > away ~ 2,
                            home < away & period > 3 ~ 1,
                            TRUE ~ 0),
    away_points = case_when(away > home ~ 2,
                            away < home & period > 3 ~ 1,
                            TRUE ~ 0)
  ) %>%
  select(-c(home:SO_result)) %>%
  pivot_longer(
    home_abbreviation:away_points,
    names_to = c(NA, ".value"),
    names_sep = 5
  ) %>%
  mutate(
    win = ifelse(points == 2, 1, 0),
    loss = ifelse(points == 0, 1, 0),
    OT = ifelse(points == 1, 1, 0)
  ) %>%
  group_by(abbreviation, division_name) %>%
  # sum the points per team per division
  summarize(
    wins = sum(win),
    losses = sum(loss),
    OT = sum(OT),
    points = sum(points),
    .groups = "drop"
  ) %>%
  # create the record text that will be used on the plot
  mutate(record = str_c(wins, losses, OT, sep = "-")) %>%
  group_by(division_name) %>%
  arrange(division_name, desc(points)) %>%
  # calculate the division rank
  mutate(rank = row_number())
```

As Meghan did, let's build out a function that works for any team.

```{r}
plot_fn <- function(team_name) {
  single_team <- top_points %>%
    filter(team == team_name)
  
  team_record <- records %>%
    filter(abbreviation == team_name) %>%
    left_join(select(team_info, team_abbr, team_logo_espn),
              by = c("abbreviation" = "team_abbr"))
  
  pts_rate_avg <- TOI %>%
    group_by(team) %>%
    summarize(avg = mean(pts_per_60),
              .groups = "drop") %>%
    filter(team == team_name)
  
  plot <- single_team %>%
    group_by(position) %>%
    mutate(label = ifelse(pts_per_60 == max(pts_per_60), position, NA)) %>%
    ungroup() %>%
    ggplot(aes(
      x = pts_per_60,
      y = reorder(name, pts_per_60),
      fill = position
    )) +
    geom_bar(stat = "identity") +
    scale_fill_manual(values = c("#AD9465", "#E2DED4")) +
    annotate(
      "text",
      x = max(single_team$pts_per_60) * 1.1,
      y = 11,
      vjust = 1.5,
      label = "games",
      size = 3.5
    ) +
    geom_label(
      data = single_team,
      aes(
        x = max(single_team$pts_per_60) * 1.1,
        label = GP
      ),
      fill = "#d3d3d3"
    ) +
    labs(
      x = "Points per 60 minutes",
      y = "",
      title = glue::glue(
        "Scoring rate leaders (200+ min.): {unique(single_team$full_team_name)}"
      ),
      subtitle = "2021-22 season, through Feb. 10"
    ) +
    geom_vline(xintercept = pts_rate_avg$avg,
               linetype = "dashed",
               color = "#a39d9d") +
    annotate(
      "text",
      x = pts_rate_avg$avg,
      y = 11,
      label = "team avg.",
      size = 3,
      hjust = -0.1,
      vjust = 1.5
    ) +
    geom_text(aes(label = label),
              x = 0.1,
              hjust = 0) +
    geom_text(
      aes(label = round(pts_per_60, 1)),
      vjust = 0.5,
      hjust = 1.5
    ) +
    annotate(
      "text",
      x = max(single_team$pts_per_60) * 0.8,
      y = 3,
      label = glue::glue(
        "record: {team_record$record}
                              division rank: {team_record$rank}"
      )
    ) +
    scale_x_continuous(expand = expansion(mult = c(0, .1))) +
    theme(panel.grid.major.y = element_blank(),
          legend.position = "none") +
    labs(caption = "data from hockeyR")
  
  ggdraw() +
    draw_plot(plot) +
    draw_image(
      team_record$team_logo_espn,
      x = 0.4,
      y = 0.42,
      scale = 0.15
    )
  
}
```

So, current stats for the home team here in Chicago:

```{r}
plot_fn("CHI")
```

Riley Stillman (defenseman) and Jonathan Toews () have been on and off Injured Reserve this season and did not appear in the roster dataset.

And current stats for Colorado:

```{r}
plot_fn("COL")
```




