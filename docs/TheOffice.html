<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Jim Gruman" />

<meta name="date" content="2020-03-17" />

<title>The Office for Tidy Tuesday</title>

<script src="site_libs/header-attrs-2.10/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<script src="site_libs/twitter-widget-0.0.1/widgets.js"></script>

<link rel="icon" href="https://github.com/workflowr/workflowr-assets/raw/master/img/reproducible.png">
<!-- Add a small amount of space between sections. -->
<style type="text/css">
div.section {
  padding-top: 12px;
}
</style>



<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>








<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">myTidyTuesday</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="about.html">About</a>
</li>
<li>
  <a href="license.html">License</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">The Office for Tidy Tuesday</h1>
<h4 class="author">Jim Gruman</h4>
<h4 class="date">March 17, 2020</h4>

</div>


<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-report" data-toggle="collapse" data-target="#workflowr-report">
<span class="glyphicon glyphicon-list" aria-hidden="true"></span> workflowr <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
</button>
</p>
<div id="workflowr-report" class="collapse">
<ul class="nav nav-tabs">
<li class="active">
<a data-toggle="tab" href="#summary">Summary</a>
</li>
<li>
<a data-toggle="tab" href="#checks"> Checks <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> </a>
</li>
<li>
<a data-toggle="tab" href="#versions">Past versions</a>
</li>
</ul>
<div class="tab-content">
<div id="summary" class="tab-pane fade in active">
<p>
<strong>Last updated:</strong> 2021-09-08
</p>
<p>
<strong>Checks:</strong> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> 7 <span class="glyphicon glyphicon-exclamation-sign text-danger" aria-hidden="true"></span> 0
</p>
<p>
<strong>Knit directory:</strong> <code>myTidyTuesday/</code> <span class="glyphicon glyphicon-question-sign" aria-hidden="true" title="This is the local directory in which the code in this file was executed."> </span>
</p>
<p>
This reproducible <a href="http://rmarkdown.rstudio.com">R Markdown</a> analysis was created with <a
  href="https://github.com/jdblischak/workflowr">workflowr</a> (version 1.6.2). The <em>Checks</em> tab describes the reproducibility checks that were applied when the results were created. The <em>Past versions</em> tab lists the development history.
</p>
<hr>
</div>
<div id="checks" class="tab-pane fade">
<div id="workflowr-checks" class="panel-group">
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRMarkdownfilestronguptodate"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>R Markdown file:</strong> up-to-date </a>
</p>
</div>
<div id="strongRMarkdownfilestronguptodate" class="panel-collapse collapse">
<div class="panel-body">
<p>Great! Since the R Markdown file has been committed to the Git repository, you know the exact version of the code that produced these results.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongEnvironmentstrongempty"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Environment:</strong> empty </a>
</p>
</div>
<div id="strongEnvironmentstrongempty" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! The global environment was empty. Objects defined in the global environment can affect the analysis in your R Markdown file in unknown ways. For reproduciblity it’s best to always run the code in an empty environment.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSeedstrongcodesetseed20210907code"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Seed:</strong> <code>set.seed(20210907)</code> </a>
</p>
</div>
<div id="strongSeedstrongcodesetseed20210907code" class="panel-collapse collapse">
<div class="panel-body">
<p>The command <code>set.seed(20210907)</code> was run prior to running the code in the R Markdown file. Setting a seed ensures that any results that rely on randomness, e.g. subsampling or permutations, are reproducible.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSessioninformationstrongrecorded"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Session information:</strong> recorded </a>
</p>
</div>
<div id="strongSessioninformationstrongrecorded" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Recording the operating system, R version, and package versions is critical for reproducibility.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongCachestrongnone"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Cache:</strong> none </a>
</p>
</div>
<div id="strongCachestrongnone" class="panel-collapse collapse">
<div class="panel-body">
<p>Nice! There were no cached chunks for this analysis, so you can be confident that you successfully produced the results during this run.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongFilepathsstrongrelative"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>File paths:</strong> relative </a>
</p>
</div>
<div id="strongFilepathsstrongrelative" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Using relative paths to the files within your workflowr project makes it easier to run your code on other machines.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRepositoryversionstrongahrefhttpsgithubcomopus1993myTidyTuesdaytree8013a27cac1ab4571fe0175d8ab8f4df2c6d4cb7targetblank8013a27a"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Repository version:</strong> <a href="https://github.com/opus1993/myTidyTuesday/tree/8013a27cac1ab4571fe0175d8ab8f4df2c6d4cb7" target="_blank">8013a27</a> </a>
</p>
</div>
<div id="strongRepositoryversionstrongahrefhttpsgithubcomopus1993myTidyTuesdaytree8013a27cac1ab4571fe0175d8ab8f4df2c6d4cb7targetblank8013a27a" class="panel-collapse collapse">
<div class="panel-body">
<p>
Great! You are using Git for version control. Tracking code development and connecting the code version to the results is critical for reproducibility.
</p>
<p>
The results in this page were generated with repository version <a href="https://github.com/opus1993/myTidyTuesday/tree/8013a27cac1ab4571fe0175d8ab8f4df2c6d4cb7" target="_blank">8013a27</a>. See the <em>Past versions</em> tab to see a history of the changes made to the R Markdown and HTML files.
</p>
<p>
Note that you need to be careful to ensure that all relevant files for the analysis have been committed to Git prior to generating the results (you can use <code>wflow_publish</code> or <code>wflow_git_commit</code>). workflowr only checks the R Markdown file, but you know if there are other scripts or data files that it depends on. Below is the status of the Git repository when the results were generated:
</p>
<pre><code>
Ignored files:
    Ignored:    .Rhistory
    Ignored:    .Rproj.user/
    Ignored:    catboost_info/
    Ignored:    data/2021-09-08/
    Ignored:    data/acs_poverty.rds
    Ignored:    data/hike_data.rds
    Ignored:    data/us_states.rds
    Ignored:    data/weatherstats_toronto_daily.csv

Unstaged changes:
    Modified:   code/_common.R

</code></pre>
<p>
Note that any generated files, e.g. HTML, png, CSS, etc., are not included in this status report because it is ok for generated content to have uncommitted changes.
</p>
</div>
</div>
</div>
</div>
<hr>
</div>
<div id="versions" class="tab-pane fade">

<p>
These are the previous versions of the repository in which changes were made to the R Markdown (<code>analysis/TheOffice.Rmd</code>) and HTML (<code>docs/TheOffice.html</code>) files. If you’ve configured a remote Git repository (see <code>?wflow_git_remote</code>), click on the hyperlinks in the table below to view the files as they were in that past version.
</p>
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
File
</th>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
<th>
Message
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/opus1993/myTidyTuesday/blob/8013a27cac1ab4571fe0175d8ab8f4df2c6d4cb7/analysis/TheOffice.Rmd" target="_blank">8013a27</a>
</td>
<td>
opus1993
</td>
<td>
2021-09-08
</td>
<td>
Add tweet, use common colors
</td>
</tr>
</tbody>
</table>
</div>
<hr>
</div>
</div>
</div>
<div id="lasso-regression-using-tidymodels-workflows-and-the-office-tidytuesday-dataset" class="section level1">
<h1>Lasso Regression using Tidymodels Workflows and The Office TidyTuesday DataSet</h1>
<p>Our starting point is <a href="https://juliasilge.com/blog/lasso-the-office/">Julia Silge’s Blog</a>, <a href="https://www.youtube.com/watch?v=_IvAubTDQME&amp;feature=youtu.be">David Robinson’s screencast</a> and the <a href="https://github.com/rfordatascience/tidytuesday/tree/master/data/2020/2020-03-17">R4DS 2020 week 12 dataset</a>. Also, Jared Lander delivered <a href="https://jaredlander.com/content/2018/11/ManyWaysToLasso2.html#1">Many Ways To Lasso</a> on a similar theme for the Chicago R User Group on 19 February, 2020. In this exercise, I will demonstrate how to build a LASSO regression model and choose regularization parameters.</p>
<div class="figure">
<img src="https://upload.wikimedia.org/wikipedia/en/5/58/TheOffice_S7_DVD.jpg" alt="" />
<p class="caption">The Office</p>
</div>
<div id="get-the-data" class="section level2">
<h2>Get the data</h2>
<p>The data this week comes from the <code>schrute</code> R package for <strong>The Office</strong> transcripts and <code>data.world</code> for <em>IMDB</em> ratings of each episode.</p>
<pre class="r"><code># Get the Data
office_ratings &lt;- readr::read_csv(&quot;https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-03-17/office_ratings.csv&quot;)</code></pre>
</div>
<div id="explore-the-data" class="section level2">
<h2>Explore the data</h2>
<p>Our modeling goal here is to predict the IMDB ratings for episodes of <strong>The Office</strong> based on the other characteristics of the episodes in the <code>#TidyTuesday</code> dataset. There are two datasets, one with the ratings and one with information like director, writer, and which character spoke which line. The episode numbers and titles are not consistent between them, so we can use regular expressions to do a better job of matching the datasets up for joining.</p>
<pre class="r"><code>office_ratings %&gt;%
  group_by(season) %&gt;%
  summarize(avg_rating = mean(imdb_rating)) %&gt;%
  ggplot(aes(season, avg_rating)) +
  geom_line() +
  scale_x_continuous(breaks = 1:9) +
  labs(
    title = &quot;The Office&quot;,
    subtitle = &quot;Average IMDB Rating&quot;,
    caption = paste0(&quot;Jim Gruman &quot;, Sys.Date())
  )</code></pre>
<p><img src="figure/TheOffice.Rmd/unnamed-chunk-2-1.png" width="648" style="display: block; margin: auto;" /></p>
<pre class="r"><code>office_ratings %&gt;%
  mutate(
    top_title = ifelse(imdb_rating &gt;= 9.2 | imdb_rating &lt;= 7,
      title, &quot;&quot;
    ),
    title = fct_inorder(title),
    episode_number = row_number()
  ) %&gt;%
  ggplot(aes(episode_number, imdb_rating)) +
  geom_line() +
  geom_smooth(alpha = 0.3, method = &quot;loess&quot;, formula = y ~ x) +
  geom_point(aes(color = factor(season), size = total_votes)) +
  geom_text(aes(
    label = top_title,
    y = if_else(imdb_rating &gt; 8,
      imdb_rating + 0.2,
      imdb_rating - 0.2
    )
  ),
  check_overlap = TRUE,
  hjust = 0.5
  ) +
  expand_limits(x = -15) +
  labs(
    title = &quot;Popularity of The Office episodes&quot;,
    subtitle = &quot;IMDB Rating, Color by Season, Size by # of Ratings&quot;,
    caption = paste0(&quot;Jim Gruman &quot;, Sys.Date())
  ) +
  theme(
    panel.grid.major.x = element_blank(),
    legend.position = &quot;none&quot;
  ) +
  labs(x = &quot;Episode Number&quot;, y = &quot;IMDB Rating&quot;)</code></pre>
<p><img src="figure/TheOffice.Rmd/unnamed-chunk-2-2.png" width="648" style="display: block; margin: auto;" /></p>
<pre class="r"><code>office_ratings %&gt;%
  arrange(desc(imdb_rating)) %&gt;%
  mutate(
    title = paste0(season, &quot;.&quot;, episode, &quot; &quot;, title),
    title = fct_reorder(title, imdb_rating)
  ) %&gt;%
  head(20) %&gt;%
  ggplot(aes(title, imdb_rating, color = factor(season), size = total_votes)) +
  geom_point() +
  coord_flip() +
  labs(
    color = &quot;Season&quot;,
    title = &quot;Most Popular Episodes of The Office&quot;,
    subtitle = &quot;Top 20 Season.Episode Titles, Color by Season and Size by Total Votes&quot;, caption = paste0(&quot;Jim Gruman &quot;, Sys.Date())
  )</code></pre>
<p><img src="figure/TheOffice.Rmd/unnamed-chunk-3-1.png" width="648" style="display: block; margin: auto;" /></p>
<p>To merge the datasets on episode, we have to clean the ratings file field by removing punctuation, digits, the words “part” and “parts”, and make all text lower case. Even after cleaning, three episode titles have to be manually imputed with a case_when statement to successfully join every episode rating with the text of the episode.</p>
<pre class="r"><code>remove_regex &lt;- &quot;[:punct:]|[:digit:]|parts |part |the |and&quot;

office_ratings &lt;- office_ratings %&gt;%
  transmute(
    episode_name = str_to_lower(title),
    episode_name = str_remove_all(episode_name, remove_regex),
    episode_name = str_trim(episode_name),
    imdb_rating
  )

office_ratings &lt;- office_ratings %&gt;%
  mutate(episode_name = case_when(
    episode_name == &quot;email surveillance&quot; ~ &quot;email surveilance&quot;,
    episode_name == &quot;coverup&quot; ~ &quot;cover&quot;,
    episode_name == &quot;sex ed&quot; ~ &quot;sx ed&quot;,
    TRUE ~ episode_name
  ))

office_info &lt;- schrute::theoffice %&gt;%
  mutate(
    season = as.numeric(season),
    episode = as.numeric(episode),
    episode_name = str_to_lower(episode_name),
    episode_name = str_remove_all(episode_name, remove_regex),
    episode_name = str_trim(episode_name)
  ) %&gt;%
  select(season, episode, episode_name, director, writer, character)</code></pre>
<p>Lets explore words that individual characters say, that other characters do not, that are most indicative of that person.</p>
<p>In information retrieval, tf–idf or TFIDF, short for term frequency–inverse document frequency, is a numerical statistic that is intended to reflect how important a word is to a document in a collection or corpus. It is often used as a weighting factor in searches of information retrieval, text mining, and user modeling. The tf–idf value increases proportionally to the number of times a word appears in the document and is offset by the number of documents in the corpus that contain the word, which helps to adjust for the fact that some words appear more frequently in general. tf–idf is one of the most popular term-weighting schemes today.</p>
<pre class="r"><code>office_transcripts &lt;- as_tibble(schrute::theoffice)

blacklist &lt;- c(&quot;yeah&quot;, &quot;hey&quot;, &quot;uh&quot;, &quot;gonna&quot;, &quot;lot&quot;, &quot;ah&quot;, &quot;huh&quot;, &quot;hmm&quot;, &quot;um&quot;, &quot;ha&quot;, &quot;na&quot;, &quot;no&quot;, &quot;nah&quot;, &quot;ahh&quot;)
blacklist_character &lt;- c(&quot;Group&quot;, &quot;Everyone&quot;, &quot;All&quot;)

transcript_words &lt;- office_transcripts %&gt;%
  group_by(character) %&gt;%
  filter(
    n() &gt;= 100,
    n_distinct(episode_name) &gt; 2
  ) %&gt;%
  ungroup() %&gt;%
  select(-text_w_direction) %&gt;%
  unnest_tokens(word, text) %&gt;%
  anti_join(stop_words, by = &quot;word&quot;) %&gt;%
  filter(
    !word %in% blacklist,
    !character %in% blacklist_character
  )

character_tf_idf &lt;- transcript_words %&gt;%
  add_count(word) %&gt;%
  filter(n &gt; 20) %&gt;%
  count(word, character) %&gt;%
  bind_tf_idf(word, character, n) %&gt;%
  arrange(desc(tf_idf))</code></pre>
<p>Let’s explore the content of Dwight’s and Jim’s lines. What words are most characteristic, or specific, to the character, with a high term frequency and low overall IDF.</p>
<pre class="r"><code>character_tf_idf %&gt;%
  filter(character == &quot;Dwight&quot;) %&gt;%
  mutate(word = fct_reorder(word, tf_idf)) %&gt;%
  head(20) %&gt;%
  ggplot(aes(word, tf_idf)) +
  geom_col() +
  coord_flip() +
  labs(
    title = &quot;Dwight&#39;s Lines in The Office&quot;,
    subtitle = &quot;Highest Tf-IDF words&quot;,
    caption = paste0(&quot;Jim Gruman &quot;, Sys.Date())
  )</code></pre>
<p><img src="figure/TheOffice.Rmd/unnamed-chunk-6-1.png" width="648" style="display: block; margin: auto;" /></p>
<pre class="r"><code>character_tf_idf %&gt;%
  filter(character == &quot;Jim&quot;) %&gt;%
  mutate(word = fct_reorder(word, tf_idf)) %&gt;%
  head(20) %&gt;%
  ggplot(aes(word, tf_idf)) +
  geom_col() +
  coord_flip() +
  labs(
    title = &quot;Jim&#39;s Lines in The Office&quot;,
    subtitle = &quot;Highest Tf-IDF words&quot;,
    caption = paste0(&quot;Jim Gruman &quot;, Sys.Date())
  )</code></pre>
<p><img src="figure/TheOffice.Rmd/unnamed-chunk-6-2.png" width="648" style="display: block; margin: auto;" /></p>
<pre class="r"><code>character_tf_idf %&gt;%
  filter(character %in% c(&quot;Jim&quot;, &quot;Dwight&quot;, &quot;Michael&quot;, &quot;Meredith&quot;)) %&gt;%
  group_by(character) %&gt;%
  top_n(10, tf_idf) %&gt;%
  ungroup() %&gt;%
  mutate(word = reorder_within(word, tf_idf, character)) %&gt;%
  ggplot(aes(word, tf_idf, fill = character)) +
  geom_col(show.legend = FALSE) +
  coord_flip() +
  scale_x_reordered() +
  facet_wrap(~character, scales = &quot;free&quot;) +
  labs(
    title = &quot;Character Lines in The Office&quot;,
    subtitle = &quot;Words most specific to a character&quot;,
    caption = paste0(&quot;Jim Gruman &quot;, Sys.Date()),
    x = &quot;&quot;, y = &quot;TF-IDF of character-word pairs&quot;
  )</code></pre>
<p><img src="figure/TheOffice.Rmd/unnamed-chunk-6-3.png" width="648" style="display: block; margin: auto;" /></p>
<p>We are going to use several different kinds of features for modeling. Let’s find out how many times characters speak per episode.</p>
<pre class="r"><code>characters &lt;- office_info %&gt;%
  count(episode_name, character) %&gt;%
  add_count(character, wt = n, name = &quot;character_count&quot;) %&gt;%
  filter(character_count &gt; 800) %&gt;%
  select(-character_count) %&gt;%
  pivot_wider(
    names_from = character,
    values_from = n,
    values_fill = list(n = 0)
  )</code></pre>
<p>And, let’s find which directors and writers are involved in each episode. I’m choosing here to combine this into one category in modeling, for a simpler model, since these are often the same individuals. And we will only model on creators that were involved in at least 15 distinct episodes.</p>
<pre class="r"><code>creators &lt;- office_info %&gt;%
  distinct(episode_name, director, writer) %&gt;%
  pivot_longer(director:writer, names_to = &quot;role&quot;, values_to = &quot;person&quot;) %&gt;%
  separate_rows(person, sep = &quot;;&quot;) %&gt;%
  add_count(person) %&gt;%
  filter(n &gt; 15) %&gt;%
  distinct(episode_name, person) %&gt;%
  mutate(person_value = 1) %&gt;%
  pivot_wider(
    names_from = person,
    values_from = person_value,
    values_fill = list(person_value = 0)
  )</code></pre>
<p>Next, let’s find the season and episode number for each episode, and then finally put it all together into one dataset for modeling.</p>
<pre class="r"><code>office &lt;- office_info %&gt;%
  distinct(season, episode, episode_name) %&gt;%
  inner_join(characters) %&gt;%
  inner_join(creators) %&gt;%
  inner_join(office_ratings %&gt;%
    select(episode_name, imdb_rating)) %&gt;%
  janitor::clean_names()</code></pre>
<p>One more quick peek into the dataset. This time, across all seasons, do the ratings of the episodes follow a pattern through the course of the season? Ratings appear to be higher for episodes later in the season. What else is associated with higher ratings? Let’s use LASSO regression to find out!</p>
<pre class="r"><code>office %&gt;%
  ggplot(aes(episode,
    imdb_rating,
    fill = as.factor(episode)
  )) +
  geom_boxplot(show.legend = FALSE) +
  scale_x_continuous(breaks = 1:28) +
  labs(
    title = &quot;The Office Ratings&quot;,
    subtitle = &quot;IMDB, by episode, across all seasons&quot;,
    caption = paste0(&quot;Jim Gruman &quot;, Sys.Date()),
    x = NULL, y = &quot;IMDB Rating&quot;
  )</code></pre>
<p><img src="figure/TheOffice.Rmd/unnamed-chunk-10-1.png" width="648" style="display: block; margin: auto;" /></p>
</div>
<div id="train-a-model" class="section level2">
<h2>Train a Model</h2>
<p>We can start by splitting our data into training and testing sets.</p>
<pre class="r"><code>office_split &lt;- initial_split(office, strata = season)
office_train &lt;- training(office_split)
office_test &lt;- testing(office_split)</code></pre>
<p>Then, we build a recipe for data preprocessing.</p>
<p>First, we must tell the <code>recipe()</code> what our model is going to be (using a formula here) and what our training data is.</p>
<p>Next, we update the role for <code>episode_name</code>, since this is a variable we might like to keep around for convenience as an identifier for rows but is not a predictor or outcome.</p>
<p>Next, we remove any numeric variables that have zero variance.</p>
<p>As a last step, we normalize (center and scale) the numeric variables. We need to do this because it’s important for LASSO regularization.</p>
<p>The object <code>office_rec</code> is a recipe that has not been trained on data yet (for example, the centered and scaling has not been calculated) and office_prep is an object that has been trained on data. The reason I use strings_as_factors = FALSE here is that my ID column episode_name is of type character (as opposed to, say, integers).</p>
<pre class="r"><code>office_rec &lt;- recipe(imdb_rating ~ ., data = office_train) %&gt;%
  update_role(episode_name, new_role = &quot;ID&quot;) %&gt;%
  step_zv(all_numeric(), -all_outcomes()) %&gt;%
  step_normalize(all_numeric(), -all_outcomes())

office_prep &lt;- office_rec %&gt;%
  prep(strings_as_factors = FALSE) # the episode ID column remains a string</code></pre>
<p>Now it’s time to specify and then fit our models. Here I set up one model specification for LASSO regression; I picked a value for penalty (sort of randomly) and I set <code>mixture = 1</code> for LASSO. I am using a <code>workflow()</code> in this example for convenience; these are objects that can help you manage modeling pipelines more easily, with pieces that fit together like Lego blocks. You can <code>fit()</code> a workflow, much like you can fit a model.</p>
<pre class="r"><code>lasso_spec &lt;- linear_reg(penalty = 0.1, mixture = 1) %&gt;%
  set_engine(&quot;glmnet&quot;)

wf &lt;- workflow() %&gt;%
  add_recipe(office_rec)

lasso_fit &lt;- wf %&gt;%
  add_model(lasso_spec) %&gt;%
  fit(data = office_train)</code></pre>
<p>If you have used <code>glmnet</code> before, this is the familiar output where we can see (here, for the most regularized examples) the features that contribute to higher IMDB ratings.</p>
</div>
<div id="tune-lasso-parameters" class="section level2">
<h2>Tune LASSO parameters</h2>
<p>So we managed to fit one LASSO model, but how do we know the right regularization parameter penalty? We can figure that out using resampling and tuning the model. Let’s build a set of bootstrap resamples, and set <code>penalty = tune()</code> instead of to a single value. We can use a function <code>penalty()</code> to set up an appropriate grid for this kind of regularization model.</p>
<pre class="r"><code>set.seed(42)
office_boot &lt;- bootstraps(office_train, strata = season)

tune_spec &lt;- linear_reg(penalty = tune(), mixture = 1) %&gt;%
  set_engine(&quot;glmnet&quot;)

lambda_grid &lt;- grid_regular(penalty(), levels = 40)</code></pre>
<p>Now it’s time to tune the grid, using our workflow object.</p>
<pre class="r"><code>all_cores &lt;- parallelly::availableCores(omit = 1)
all_cores</code></pre>
<pre><code>system 
    11 </code></pre>
<pre class="r"><code>future::plan(&quot;multisession&quot;, workers = all_cores) # on Windows

set.seed(42)
lasso_grid &lt;- tune_grid(
  wf %&gt;% add_model(tune_spec),
  resamples = office_boot,
  grid = lambda_grid
)</code></pre>
<p>Let’s take a look at a visualization of performance with the regularization parameter.</p>
<pre class="r"><code>lasso_grid %&gt;%
  collect_metrics() %&gt;%
  ggplot(aes(penalty, mean, color = .metric)) +
  geom_errorbar(aes(
    ymin = mean - std_err,
    ymax = mean + std_err
  ),
  alpha = 0.5
  ) +
  geom_line(size = 1.5) +
  facet_wrap(~.metric, scales = &quot;free&quot;, nrow = 2) +
  scale_x_log10() +
  theme(legend.position = &quot;none&quot;)</code></pre>
<p><img src="figure/TheOffice.Rmd/unnamed-chunk-16-1.png" width="648" style="display: block; margin: auto;" /></p>
<p>This is a great way to see that regularization helps this modeling a lot. We have a couple of options for choosing our final parameter, such as <code>select_by_pct_loss()</code> or <code>select_by_one_std_err()</code>, but for now let’s stick with just picking the lowest RMSE. After we have that parameter, we can finalize our workflow, i.e. update it with this value.</p>
<pre class="r"><code>lowest_rmse &lt;- lasso_grid %&gt;%
  select_best(&quot;rmse&quot;)

final_lasso &lt;- finalize_workflow(
  wf %&gt;% add_model(tune_spec),
  lowest_rmse
)

final_lasso</code></pre>
<pre><code>== Workflow ====================================================================
Preprocessor: Recipe
Model: linear_reg()

-- Preprocessor ----------------------------------------------------------------
2 Recipe Steps

* step_zv()
* step_normalize()

-- Model -----------------------------------------------------------------------
Linear Regression Model Specification (regression)

Main Arguments:
  penalty = 0.0289426612471674
  mixture = 1

Computational engine: glmnet </code></pre>
<p>The optimal penalty is shown here as 0.0289</p>
<p>We can then fit this finalized workflow on our training data. While we’re at it, let’s see what the most important variables are using the <code>vip</code> package.</p>
<pre class="r"><code>final_lasso %&gt;%
  fit(office_train) %&gt;%
  pull_workflow_fit() %&gt;%
  vip::vi(lambda = lowest_rmse$penalty) %&gt;%
  mutate(
    Importance = abs(Importance),
    Variable = fct_reorder(Variable, Importance)
  ) %&gt;%
  ggplot(aes(x = Importance, y = Variable, fill = Sign)) +
  geom_col() +
  scale_x_continuous(expand = c(0, 0)) +
  labs(y = NULL)</code></pre>
<p><img src="figure/TheOffice.Rmd/unnamed-chunk-18-1.png" width="648" style="display: block; margin: auto;" /></p>
<p>Clearly, the features with the greatest importance in predicting IMDB rating include the presence of Greg Daniels, Michael, the episode itself, B J Novak, and Jan.</p>
<p>And then, finally, let’s return to our test data. The <code>tune</code> package has a function <code>last_fit()</code> which is nice for situations when you have tuned and finalized a model or workflow and want to fit it one last time on your training data and evaluate it on your testing data. You only have to pass this function your finalized model/workflow and your split.</p>
<pre class="r"><code>last_fit(
  final_lasso,
  office_split
) %&gt;%
  collect_metrics() %&gt;%
  knitr::kable()</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">.metric</th>
<th align="left">.estimator</th>
<th align="right">.estimate</th>
<th align="left">.config</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">rmse</td>
<td align="left">standard</td>
<td align="right">0.5326722</td>
<td align="left">Preprocessor1_Model1</td>
</tr>
<tr class="even">
<td align="left">rsq</td>
<td align="left">standard</td>
<td align="right">0.0698854</td>
<td align="left">Preprocessor1_Model1</td>
</tr>
</tbody>
</table>
<p>The tweet for week 12 of 2020:</p>
<pre class="r"><code>tweetrmd::include_tweet(&quot;https://twitter.com/jim_gruman/status/1241190749829545988&quot;)</code></pre>
<blockquote class="twitter-tweet" data-width="550" data-lang="en" data-dnt="true" data-theme="light"><p lang="en" dir="ltr"><a href="https://twitter.com/hashtag/TidyTuesday?src=hash&amp;ref_src=twsrc%5Etfw">#TidyTuesday</a> Week 12 - <a href="https://twitter.com/hashtag/TheOffice?src=hash&amp;ref_src=twsrc%5Etfw">#TheOffice</a> <br><br>Finding drivers for the IMDB ratings for each episode of The Office, for the characters and the writers involved<a href="https://t.co/9ZRtO79myn">https://t.co/9ZRtO79myn</a><a href="https://twitter.com/hashtag/rstats?src=hash&amp;ref_src=twsrc%5Etfw">#rstats</a> <a href="https://twitter.com/hashtag/dataviz?src=hash&amp;ref_src=twsrc%5Etfw">#dataviz</a> <a href="https://twitter.com/hashtag/r4ds?src=hash&amp;ref_src=twsrc%5Etfw">#r4ds</a> <a href="https://t.co/T8TxACqe0L">pic.twitter.com/T8TxACqe0L</a></p>&mdash; Jim Gruman📚🚵‍♂️⚙ (@jim_gruman) <a href="https://twitter.com/jim_gruman/status/1241190749829545988?ref_src=twsrc%5Etfw">March 21, 2020</a></blockquote>

<br>
<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-sessioninfo" data-toggle="collapse" data-target="#workflowr-sessioninfo" style="display: block;">
<span class="glyphicon glyphicon-wrench" aria-hidden="true"></span> Session information
</button>
</p>
<div id="workflowr-sessioninfo" class="collapse">
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>R version 4.1.1 (2021-08-10)
Platform: x86_64-w64-mingw32/x64 (64-bit)
Running under: Windows 10 x64 (build 19043)

Matrix products: default

locale:
[1] LC_COLLATE=English_United States.1252 
[2] LC_CTYPE=English_United States.1252   
[3] LC_MONETARY=English_United States.1252
[4] LC_NUMERIC=C                          
[5] LC_TIME=English_United States.1252    

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] glmnet_4.1-2       Matrix_1.3-4       vctrs_0.3.8        rlang_0.4.11      
 [5] vip_0.3.2          tidytext_0.3.1     forcats_0.5.1      stringr_1.4.0     
 [9] readr_2.0.1        tidyverse_1.3.1    yardstick_0.0.8    workflowsets_0.1.0
[13] workflows_0.2.3    tune_0.1.6         tidyr_1.1.3        tibble_3.1.4      
[17] rsample_0.1.0      recipes_0.1.16     purrr_0.3.4        parsnip_0.1.7.900 
[21] modeldata_0.1.1    infer_1.0.0        ggplot2_3.3.5      dplyr_1.0.7       
[25] dials_0.0.9.9000   scales_1.1.1       broom_0.7.9        tidymodels_0.1.3  
[29] workflowr_1.6.2   

loaded via a namespace (and not attached):
  [1] readxl_1.3.1       backports_1.2.1    systemfonts_1.0.2 
  [4] plyr_1.8.6         schrute_0.2.2      splines_4.1.1     
  [7] listenv_0.8.0      SnowballC_0.7.0    digest_0.6.27     
 [10] foreach_1.5.1      htmltools_0.5.2    viridis_0.6.1     
 [13] fansi_0.5.0        magrittr_2.0.1     tzdb_0.1.2        
 [16] globals_0.14.0     modelr_0.1.8       gower_0.2.2       
 [19] extrafont_0.17     vroom_1.5.4        R.utils_2.10.1    
 [22] extrafontdb_1.0    hardhat_0.1.6      colorspace_2.0-2  
 [25] rvest_1.0.1        textshaping_0.3.5  haven_2.4.3       
 [28] xfun_0.25          crayon_1.4.1       jsonlite_1.7.2    
 [31] survival_3.2-11    iterators_1.0.13   glue_1.4.2        
 [34] gtable_0.3.0       ipred_0.9-11       R.cache_0.15.0    
 [37] tweetrmd_0.0.9     Rttf2pt1_1.3.9     shape_1.4.6       
 [40] future.apply_1.8.1 DBI_1.1.1          Rcpp_1.0.7        
 [43] viridisLite_0.4.0  bit_4.0.4          GPfit_1.0-8       
 [46] lava_1.6.10        prodlim_2019.11.13 httr_1.4.2        
 [49] ellipsis_0.3.2     farver_2.1.0       R.methodsS3_1.8.1 
 [52] pkgconfig_2.0.3    nnet_7.3-16        sass_0.4.0        
 [55] dbplyr_2.1.1       janitor_2.1.0      utf8_1.2.2        
 [58] here_1.0.1         labeling_0.4.2     tidyselect_1.1.1  
 [61] DiceDesign_1.9     later_1.3.0        munsell_0.5.0     
 [64] cellranger_1.1.0   tools_4.1.1        cachem_1.0.6      
 [67] cli_3.0.1          generics_0.1.0     evaluate_0.14     
 [70] fastmap_1.1.0      yaml_2.2.1         ragg_1.1.3        
 [73] rematch2_2.1.2     bit64_4.0.5        knitr_1.33        
 [76] fs_1.5.0           nlme_3.1-152       future_1.22.1     
 [79] whisker_0.4        R.oo_1.24.0        xml2_1.3.2        
 [82] tokenizers_0.2.1   compiler_4.1.1     rstudioapi_0.13   
 [85] curl_4.3.2         reprex_2.0.1       lhs_1.1.1         
 [88] bslib_0.3.0        stringi_1.7.4      highr_0.9         
 [91] gdtools_0.2.3      hrbrthemes_0.8.0   lattice_0.20-44   
 [94] styler_1.5.1       conflicted_1.0.4   pillar_1.6.2      
 [97] lifecycle_1.0.0    furrr_0.2.3        jquerylib_0.1.4   
[100] httpuv_1.6.2       R6_2.5.1           promises_1.2.0.1  
[103] gridExtra_2.3      janeaustenr_0.1.5  parallelly_1.27.0 
[106] codetools_0.2-18   MASS_7.3-54        assertthat_0.2.1  
[109] rprojroot_2.0.2    withr_2.4.2        mgcv_1.8-36       
[112] parallel_4.1.1     hms_1.1.0          grid_4.1.1        
[115] rpart_4.1-15       timeDate_3043.102  class_7.3-19      
[118] snakecase_0.11.0   rmarkdown_2.10     git2r_0.28.0      
[121] pROC_1.18.0        lubridate_1.7.10  </code></pre>
</div>
</div>
</div>


<!-- Adjust MathJax settings so that all math formulae are shown using
TeX fonts only; see
http://docs.mathjax.org/en/latest/configuration.html.  This will make
the presentation more consistent at the cost of the webpage sometimes
taking slightly longer to load. Note that this only works because the
footer is added to webpages before the MathJax javascript. -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>





</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
